<form [formGroup]="form" (submit)="save()">
  <mat-tab-group>
    <!-- GENERAL -->
    <mat-tab label="general">
      <div>
        <!-- start -->
        <mat-form-field>
          <mat-label>start</mat-label>
          <input matInput [formControl]="start" />
          <mat-error
            *ngIf="start.errors?.required && (start.dirty || start.touched)"
            >start required</mat-error
          >
          <mat-error
            *ngIf="start.errors?.pattern && (start.dirty || start.touched)"
            >invalid start</mat-error
          >
        </mat-form-field>

        &nbsp;
        <!-- end -->
        <mat-form-field>
          <mat-label>end</mat-label>
          <input matInput [formControl]="end" />
          <mat-error *ngIf="end.errors?.required && (end.dirty || end.touched)"
            >end required</mat-error
          >
          <mat-error *ngIf="end.errors?.pattern && (end.dirty || end.touched)"
            >invalid end</mat-error
          >
        </mat-form-field>
      </div>

      <div class="form-row">
        <!-- material (bound) -->
        <mat-form-field *ngIf="matEntries?.length">
          <mat-label>material</mat-label>
          <mat-select [formControl]="material">
            <mat-option *ngFor="let e of matEntries" [value]="e.id">{{
              e.value
            }}</mat-option>
          </mat-select>
        </mat-form-field>

        <!-- material (free) -->
        <mat-form-field *ngIf="!matEntries?.length">
          <mat-label>material</mat-label>
          <input matInput [formControl]="material" />
          <mat-error
            *ngIf="
              material.errors?.maxLength && (material.dirty || material.touched)
            "
            >too long</mat-error
          >
        </mat-form-field>

        <!-- guard sheets material (bound) -->
        <mat-form-field *ngIf="matEntries?.length">
          <mat-label>guards material</mat-label>
          <mat-select [formControl]="guardSheetMaterial">
            <mat-option *ngFor="let e of matEntries" [value]="e.id">{{
              e.value
            }}</mat-option>
          </mat-select>
        </mat-form-field>

        <!-- guard sheets material (free) -->
        <mat-form-field *ngIf="!matEntries?.length">
          <mat-label>guards material</mat-label>
          <input matInput [formControl]="guardSheetMaterial" />
          <mat-error
            *ngIf="
              guardSheetMaterial.errors?.maxLength &&
              (guardSheetMaterial.dirty || guardSheetMaterial.touched)
            "
            >too long</mat-error
          >
        </mat-form-field>

        <!-- sheetCount -->
        <mat-form-field style="width: 5em">
          <mat-label>sheets count</mat-label>
          <input
            matInput
            [formControl]="sheetCount"
            type="number"
            min="0"
            max="1000"
          />
        </mat-form-field>

        <!-- guardSheetCount -->
        <mat-form-field style="width: 5em">
          <mat-label>guard sheets count</mat-label>
          <input
            matInput
            [formControl]="guardSheetCount"
            type="number"
            min="0"
            max="100"
          />
        </mat-form-field>

        <!-- backGuardSheetCount -->
        <mat-form-field style="width: 5em">
          <mat-label>back guard sheets count</mat-label>
          <input
            matInput
            [formControl]="backGuardSheetCount"
            type="number"
            min="0"
            max="100"
          />
        </mat-form-field>
      </div>

      <div class="form-row">
        <!-- group ID -->
        <mat-form-field>
          <mat-label>group ID</mat-label>
          <input matInput [formControl]="groupId" />
          <mat-error
            *ngIf="
              groupId.errors?.maxLength && (groupId.dirty || groupId.touched)
            "
            >ID too long</mat-error
          >
        </mat-form-field>

        <!-- groupOrdinal -->
        <mat-form-field style="width: 5em">
          <mat-label>group ordinal</mat-label>
          <input matInput [formControl]="groupOrdinal" type="number" min="0" />
        </mat-form-field>
      </div>

      <!-- date -->
      <div>
        <mat-checkbox [formControl]="hasDate">has date</mat-checkbox>
        <cadmus-refs-historical-date
          *ngIf="hasDate?.value"
          [date]="$any(date)"
          (dateChange)="onDateChange($event)"
        ></cadmus-refs-historical-date>
      </div>

      <!-- quires -->
      <div>
        <mat-form-field class="long-text">
          <mat-label>quires</mat-label>
          <textarea rows="3" matInput [formControl]="quires"></textarea>
          <mat-error
            *ngIf="quires.errors?.maxLength && (quires.dirty || quires.touched)"
            >too long</mat-error
          >
        </mat-form-field>
      </div>
      <!-- sheetNumbering -->
      <div>
        <mat-form-field class="long-text">
          <mat-label>sheet numbering</mat-label>
          <textarea rows="3" matInput [formControl]="sheetNumbering"></textarea>
          <mat-error
            *ngIf="
              sheetNumbering.errors?.maxLength &&
              (sheetNumbering.dirty || sheetNumbering.touched)
            "
            >too long</mat-error
          >
        </mat-form-field>
      </div>
      <!-- quireNumbering -->
      <div>
        <mat-form-field class="long-text">
          <mat-label>quire numbering</mat-label>
          <textarea rows="3" matInput [formControl]="quireNumbering"></textarea>
          <mat-error
            *ngIf="
              quireNumbering.errors?.maxLength &&
              (quireNumbering.dirty || quireNumbering.touched)
            "
            >too long</mat-error
          >
        </mat-form-field>
      </div>
      <!-- state -->
      <div>
        <mat-form-field class="long-text">
          <mat-label>state</mat-label>
          <textarea rows="3" matInput [formControl]="state"></textarea>
          <mat-error
            *ngIf="state.errors?.maxLength && (state.dirty || state.touched)"
            >too long</mat-error
          >
        </mat-form-field>
      </div>
      <!-- binding -->
      <div>
        <mat-form-field class="long-text">
          <mat-label>binding</mat-label>
          <textarea rows="3" matInput [formControl]="binding"></textarea>
          <mat-error
            *ngIf="
              binding.errors?.maxLength && (binding.dirty || binding.touched)
            "
            >too long</mat-error
          >
        </mat-form-field>
      </div>
    </mat-tab>
    <!-- RULINGS -->
    <mat-tab label="rulings">
      <div formArrayName="rulings">
        <div>
          <button
            type="button"
            mat-flat-button
            color="primary"
            (click)="addRuling()"
          >
            <mat-icon>add_circle</mat-icon>
            ruling
          </button>
        </div>
        <div
          *ngFor="
            let item of rulings.controls;
            let i = index;
            let first = first;
            let last = last
          "
        >
          <div [formGroupName]="i">
            {{ i + 1 }}.
            <button
              mat-icon-button
              type="button"
              matTooltip="Remove this ruling"
              color="warn"
              (click)="removeRuling(i)"
            >
              <mat-icon>remove_circle</mat-icon>
            </button>
            <button
              [disabled]="first"
              mat-icon-button
              type="button"
              matTooltip="Move ruling up"
              (click)="moveRulingUp(i)"
            >
              <mat-icon>arrow_upward</mat-icon>
            </button>
            <button
              [disabled]="last"
              mat-icon-button
              type="button"
              matTooltip="Move ruling down"
              (click)="moveRulingDown(i)"
            >
              <mat-icon>arrow_downward</mat-icon>
            </button>

            <!-- child controls -->
            <!-- manner (bound) -->
            <mat-form-field *ngIf="rulManEntries?.length">
              <mat-label>manner</mat-label>
              <mat-select formControlName="manner">
                <mat-option *ngFor="let e of rulManEntries" [value]="e.id">{{
                  e.value
                }}</mat-option>
              </mat-select>
              <mat-error
                *ngIf="
                  $any(item)['controls'].manner.errors?.required &&
                  ($any(item)['controls'].manner.dirty ||
                    $any(item)['controls'].manner.touched)
                "
                >manner required</mat-error
              >
            </mat-form-field>
            <!-- manner (free) -->
            <mat-form-field *ngIf="!rulManEntries?.length">
              <mat-label>manner</mat-label>
              <input matInput formControlName="manner" />
              <mat-error
                *ngIf="
                  $any(item)['controls'].manner.errors?.required &&
                  ($any(item)['controls'].manner.dirty ||
                    $any(item)['controls'].manner.touched)
                "
                >manner required</mat-error
              >
              <mat-error
                *ngIf="
                  $any(item)['controls'].manner.errors?.maxLength &&
                  ($any(item)['controls'].manner.dirty ||
                    $any(item)['controls'].manner.touched)
                "
                >too long</mat-error
              >
            </mat-form-field>

            &nbsp;
            <!-- system (bound) -->
            <mat-form-field *ngIf="rulSysEntries?.length">
              <mat-label>system</mat-label>
              <mat-select formControlName="system">
                <mat-option *ngFor="let e of rulSysEntries" [value]="e.id">{{
                  e.value
                }}</mat-option>
              </mat-select>
              <mat-error
                *ngIf="
                  $any(item)['controls'].system.errors?.required &&
                  ($any(item)['controls'].system.dirty ||
                    $any(item)['controls'].system.touched)
                "
                >system required</mat-error
              >
            </mat-form-field>
            <!-- system (free) -->
            <mat-form-field *ngIf="!rulSysEntries?.length">
              <mat-label>system</mat-label>
              <input matInput formControlName="system" />
              <mat-error
                *ngIf="
                  $any(item)['controls'].system.errors?.required &&
                  ($any(item)['controls'].system.dirty ||
                    $any(item)['controls'].system.touched)
                "
                >system required</mat-error
              >
              <mat-error
                *ngIf="
                  $any(item)['controls'].system.errors?.maxLength &&
                  ($any(item)['controls'].system.dirty ||
                    $any(item)['controls'].system.touched)
                "
                >too long</mat-error
              >
            </mat-form-field>

            <!-- type -->
            &nbsp;
            <mat-form-field>
              <mat-label>type</mat-label>
              <input matInput formControlName="type" />
              <mat-error
                *ngIf="
                  $any(item)['controls'].type.errors?.maxLength &&
                  ($any(item)['controls'].type.dirty ||
                    $any(item)['controls'].type.touched)
                "
                >too long</mat-error
              >
            </mat-form-field>

            <div>
              <!-- description -->
              <mat-form-field class="long-text-indented">
                <mat-label>description</mat-label>
                <textarea matInput formControlName="description"></textarea>
                <mat-error
                  *ngIf="
                    $any(item)['controls'].description.errors?.maxLength &&
                    ($any(item)['controls'].description.dirty ||
                      $any(item)['controls'].description.touched)
                  "
                  >description too long</mat-error
                >
              </mat-form-field>
            </div>
          </div>
        </div>
      </div>
    </mat-tab>
    <!-- LEAF SIZES -->
    <mat-tab label="leaf sizes">
      <div>
        <mat-form-field class="long-text">
          <mat-label>samples</mat-label>
          <input matInput [formControl]="leafSizeSamples" />
          <mat-hint>comma delimited</mat-hint>
          <mat-error
            *ngIf="
              leafSizeSamples.errors?.pattern &&
              (leafSizeSamples.dirty || leafSizeSamples.touched)
            "
            >invalid</mat-error
          >
          <mat-error
            *ngIf="
              leafSizeSamples.errors?.maxLength &&
              (leafSizeSamples.dirty || leafSizeSamples.touched)
            "
            >too long</mat-error
          >
        </mat-form-field>
      </div>
      <button
        type="button"
        mat-flat-button
        color="primary"
        (click)="addLeafSize()"
      >
        <mat-icon>add_circle</mat-icon> size
      </button>
      <table *ngIf="leafSizes?.length">
        <thead>
          <tr>
            <th></th>
            <th>tag</th>
            <th>w</th>
            <th>h</th>
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="
              let size of leafSizes;
              let i = index;
              let first = first;
              let last = last
            "
          >
            <td>
              <button
                mat-icon-button
                type="button"
                color="primary"
                matTooltip="Edit this size"
                (click)="editLeafSize(i)"
              >
                <mat-icon>edit</mat-icon>
              </button>
              <button
                mat-icon-button
                type="button"
                matTooltip="Remove this size"
                color="warn"
                (click)="removeLeafSize(i)"
              >
                <mat-icon>remove_circle</mat-icon>
              </button>
              <button
                [disabled]="first"
                mat-icon-button
                type="button"
                matTooltip="Move size up"
                (click)="moveLeafSizeUp(i)"
              >
                <mat-icon>arrow_upward</mat-icon>
              </button>
              <button
                [disabled]="last"
                mat-icon-button
                type="button"
                matTooltip="Move size down"
                (click)="moveLeafSizeDown(i)"
              >
                <mat-icon>arrow_downward</mat-icon>
              </button>
            </td>
            <td>
              {{ size.tag }}
            </td>
            <td>
              {{ dimToString(size.w) }}
            </td>
            <td>
              {{ dimToString(size.h) }}
            </td>
          </tr>
        </tbody>
      </table>
      <mat-expansion-panel
        [expanded]="editingLeafSize"
        [disabled]="!editingLeafSize"
      >
        <mat-expansion-panel-header>size</mat-expansion-panel-header>
        <cadmus-mat-physical-size
          [unitEntries]="$any(szUnitEntries)"
          [tagEntries]="$any(szTagEntries)"
          [hBeforeW]="true"
          [dimTagEntries]="$any(szDimTagEntries)"
          [size]="$any(editedLeafSize)"
          (sizeChange)="onEditedLeafSizeChange($event)"
        ></cadmus-mat-physical-size>
        <button
          type="button"
          mat-icon-button
          (click)="editLeafSize(-1)"
          matTooltip="Discard size"
        >
          <mat-icon color="warn">clear</mat-icon>
        </button>
        <button
          type="button"
          mat-icon-button
          (click)="saveLeafSize()"
          matTooltip="Save size"
        >
          <mat-icon color="primary">check_circle</mat-icon>
        </button>
      </mat-expansion-panel>
    </mat-tab>
    <!-- AREA SIZES -->
    <mat-tab label="area sizes">
      <div>
        <mat-form-field class="long-text">
          <mat-label>samples</mat-label>
          <input matInput [formControl]="areaSizeSamples" />
          <mat-hint>comma delimited</mat-hint>
          <mat-error
            *ngIf="
              areaSizeSamples.errors?.pattern &&
              (areaSizeSamples.dirty || areaSizeSamples.touched)
            "
            >invalid</mat-error
          >
          <mat-error
            *ngIf="
              areaSizeSamples.errors?.maxLength &&
              (areaSizeSamples.dirty || areaSizeSamples.touched)
            "
            >too long</mat-error
          >
        </mat-form-field>
      </div>
      <button
        type="button"
        mat-flat-button
        color="primary"
        (click)="addAreaSize()"
      >
        <mat-icon>add_circle</mat-icon> size
      </button>
      <table *ngIf="areaSizes?.length">
        <thead>
          <tr>
            <th></th>
            <th>tag</th>
            <th>w</th>
            <th>h</th>
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="
              let size of areaSizes;
              let i = index;
              let first = first;
              let last = last
            "
          >
            <td>
              <button
                mat-icon-button
                type="button"
                color="primary"
                matTooltip="Edit this size"
                (click)="editAreaSize(i)"
              >
                <mat-icon>edit</mat-icon>
              </button>
              <button
                mat-icon-button
                type="button"
                matTooltip="Remove this size"
                color="warn"
                (click)="removeAreaSize(i)"
              >
                <mat-icon>remove_circle</mat-icon>
              </button>
              <button
                [disabled]="first"
                mat-icon-button
                type="button"
                matTooltip="Move size up"
                (click)="moveAreaSizeUp(i)"
              >
                <mat-icon>arrow_upward</mat-icon>
              </button>
              <button
                [disabled]="last"
                mat-icon-button
                type="button"
                matTooltip="Move size down"
                (click)="moveAreaSizeDown(i)"
              >
                <mat-icon>arrow_downward</mat-icon>
              </button>
            </td>
            <td>
              {{ size.tag }}
            </td>
            <td>
              {{ dimToString(size.w) }}
            </td>
            <td>
              {{ dimToString(size.h) }}
            </td>
          </tr>
        </tbody>
      </table>
      <mat-expansion-panel
        [expanded]="editingAreaSize"
        [disabled]="!editingAreaSize"
      >
        <mat-expansion-panel-header>size</mat-expansion-panel-header>
        <cadmus-mat-physical-size
          [unitEntries]="$any(szUnitEntries)"
          [tagEntries]="$any(szTagEntries)"
          [hBeforeW]="true"
          [dimTagEntries]="$any(szDimTagEntries)"
          [size]="$any(editedAreaSize)"
          (sizeChange)="onEditedAreaSizeChange($event)"
        ></cadmus-mat-physical-size>
        <button
          type="button"
          mat-icon-button
          (click)="editAreaSize(-1)"
          matTooltip="Discard size"
        >
          <mat-icon color="warn">clear</mat-icon>
        </button>
        <button
          type="button"
          mat-icon-button
          (click)="saveAreaSize()"
          matTooltip="Save size"
        >
          <mat-icon color="primary">check_circle</mat-icon>
        </button>
      </mat-expansion-panel>
    </mat-tab>
    <!-- WATERMARKS -->
    <mat-tab label="watermarks">
      <div formArrayName="watermarks">
        <div>
          <button
            type="button"
            mat-flat-button
            color="primary"
            (click)="addWatermark()"
          >
            <mat-icon>add_circle</mat-icon>
            watermark
          </button>
        </div>
        <div
          *ngFor="
            let item of watermarks.controls;
            let i = index;
            let first = first;
            let last = last
          "
        >
          <!-- child form -->
          <div [formGroupName]="i">
            <!-- child actions -->
            {{ i + 1 }}.
            <button
              mat-icon-button
              type="button"
              matTooltip="Remove this watermark"
              color="warn"
              (click)="removeWatermark(i)"
            >
              <mat-icon>remove_circle</mat-icon>
            </button>
            <button
              [disabled]="first"
              mat-icon-button
              type="button"
              matTooltip="Move watermark up"
              (click)="moveWatermarkUp(i)"
            >
              <mat-icon>arrow_upward</mat-icon>
            </button>
            <button
              [disabled]="last"
              mat-icon-button
              type="button"
              matTooltip="Move watermark down"
              (click)="moveWatermarkDown(i)"
            >
              <mat-icon>arrow_downward</mat-icon>
            </button>

            <!-- child controls -->
            <!-- value -->
            <mat-form-field>
              <mat-label>value</mat-label>
              <input matInput formControlName="value" />
              <mat-error
                *ngIf="
                  $any(item)['controls'].value.errors?.required &&
                  ($any(item)['controls'].value.dirty ||
                    $any(item)['controls'].value.touched)
                "
                >value required</mat-error
              >
              <mat-error
                *ngIf="
                  $any(item)['controls'].value.errors?.maxLength &&
                  ($any(item)['controls'].value.dirty ||
                    $any(item)['controls'].value.touched)
                "
                >value too long</mat-error
              >
            </mat-form-field>

            <!-- description -->
            <mat-form-field>
              <mat-label>description</mat-label>
              <input matInput formControlName="description" />
              <mat-error
                *ngIf="
                  $any(item)['controls'].description.errors?.required &&
                  ($any(item)['controls'].description.dirty ||
                    $any(item)['controls'].description.touched)
                "
                >description required</mat-error
              >
              <mat-error
                *ngIf="
                  $any(item)['controls'].description.errors?.maxLength &&
                  ($any(item)['controls'].description.dirty ||
                    $any(item)['controls'].description.touched)
                "
                >description too long</mat-error
              >
            </mat-form-field>
          </div>
        </div>
      </div>
    </mat-tab>
  </mat-tab-group>
  <!-- buttons -->
  <div>
    <button
      type="button"
      color="warn"
      mat-icon-button
      matTooltip="Discard unit changes"
      (click)="cancel()"
    >
      <mat-icon>clear</mat-icon>
    </button>
    <button
      type="submit"
      color="primary"
      mat-icon-button
      matTooltip="Accept unit changes"
      [disabled]="form.invalid || form.pristine"
    >
      <mat-icon>check_circle</mat-icon>
    </button>
  </div>
</form>
